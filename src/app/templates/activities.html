
{% extends "layout.html" %}
{% block body %}

<script src='/static/bower_components/tagmanager/tagmanager.js'></script>
<script src='/static/bower_components/moment/moment.js'></script>
<link rel="stylesheet" type="text/css" href="/static/bower_components/tagmanager/tagmanager.css" />

<!--I want to use this to monitor the textarea as text is entered into it, and parse out
tags, usernames, dates, and other info automatically in real time to populate the other
fields. This should lead to a potential workflow that requires no clicking, just typing
the activity string into the text area and hitting enter to bring up the next activity box-->
<script>

$SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

var lastVal = "";
var config = null;

$( document ).ready(function() {

  /** Initialization **/

  $.getJSON($SCRIPT_ROOT + '/_config', null, function(data) {
    config = data;
  });

  var tagApi = $("#tm-tags").tagsManager();
  var userTagApi = $("#tm-users").tagsManager();
  var catTagApi = $("#tm-categories").tagsManager();
  var dateTagApi = $("#tm-date").tagsManager({maxTags: 1});

  var userRE = /(@\w+)/ig
  var tagsRE = /(#\w+)/ig
  // regular expressions to match various date formats
  var dateREs = [/\d{1,2}\/\d{1,2}\/(\d\d){1,2}( |$)/ig,
                 /\d{1,2}-\d{1,2}-(\d\d){1,2}( |$)/ig,
                 /(\d\d){1,2}-\d{1,2}-(\d){2}( |$)/ig,
                 /(\d\d){1,2}\/\d{1,2}\/(\d){2}( |$)/ig]

  /** Event Methods **/

  $("#activity").on("change keyup paste", function() {
    var currentVal = $(this).val();

    if(currentVal == lastVal) {
      return; //check to prevent multiple simultaneous triggers
    }

    lastVal = currentVal;

    // empty existing
    userTagApi.tagsManager('empty');
    tagApi.tagsManager('empty');
    catTagApi.tagsManager('empty');
    dateTagApi.tagsManager('empty');

    // find user tags in string
    var users = lastVal.match(userRE);

    if(users) {
      users.forEach(function(user) {
        userTagApi.tagsManager('pushTag',user.split('@')[1]);
      });
    }

    // find hash tags in string
    var tags = lastVal.match(tagsRE);

    if(tags) {
      var tag = null;
      tags.forEach(function(tag) {
        tag = tag.split('#')[1];

        // check to see if hashtag is a known category tag
        if($.inArray(tag, config.categories) >= 0) {
          catTagApi.tagsManager('pushTag',tag);
        }
        else {
          tagApi.tagsManager('pushTag',tag);
        }
      });
    }

    var dateFormats = ["MM-DD-YY","MM-DD-YYYY"]
    var dateStr = null;
    dateREs.forEach(function(re) {
        matched = lastVal.match(re);
        if(matched) dateStr = matched[0];
    });

    if(dateStr) {
        // validate date string
        if (moment(dateStr, dateFormats).isValid()) {
            dateTagApi.tagsManager('pushTag', moment(dateStr, dateFormats).format('MMMM Do YYYY'));
        }
    }

  });

  // Set listener for enter key press in activity text field
  $('#activity').keydown(function (e) {
    if(e.keyCode == 13){
      e.preventDefault();
      saveActivity();
    }
  });

  // set up async form submit
  $('.form').submit(function(event) {
      var $form = $(this);
      var data = $form.serialize();

      $.post($form.attr('action'),data).done( function(data, status) {
        console.log('Submitted form!');
      });

      event.preventDefault();
  });

});

/**
 * updateConfig()
 *
 * Send an ajax post to the server with the client's current config dict, which
 * may contain new values fo rusers, tags, or categories. The server will accept
 * this data and update the global config to add (not delete) to these lists
 * based on any new values.
 */
function updateConfig() {
    $.ajax({
        url: $SCRIPT_ROOT + '/api/config',
        type: "POST",
        data: JSON.stringify(config),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(res){
          console.log('Posted. response: ' + JSON.stringify(res));
        }
    }).fail(function( jqXhr, textStatus, errorThrown ){ console.log( 'POST error: ' + errorThrown ); });
}

function saveActivity() {
  // submit form
  $('.form').submit();

  // move data from form into background display of submitted activities
  console.log('tags: ' + $('[name=hidden-tm-tags]').val());
  console.log('users: ' + $('[name=hidden-tm-users]').val());
  console.log('categories: ' + $('[name=hidden-tm-categories]').val());
  console.log('date: ' + $('[name=hidden-tm-date]').val());

  $('#savedActivties').prepend('<pre>' + $('[name=activity]').val() + '</pre>');

  // clear form and reset focus
  resetForm();
}

function resetForm() {
  $('[name=hidden-tm-tags]').val("");
  $('[name=hidden-tm-users]').val("");
  $('[name=hidden-tm-categories]').val("");
  $('[name=hidden-tm-date]').val("");
  $('[name=activity]').val("");
}

</script>

<form class="form" role="form" action="/activities" data-async method="POST">
    <div class="form-group">
        <div class="input-group">
            <span class="input-group-addon">Activity </span>
            <textarea id="activity" name="activity" type="text" class="form-control" placeholder="Activity Description" autofocus></textarea>
        </div>
    </div>
    <div class="form-group">
        <div class="input-group">
            <div class="col-md-3">
                <input type="text" name="tm-tags" placeholder="Add a Tag..." id="tm-tags" class="tm-input input-medium tm-input-info"/>
            </div>
            <div class="col-md-3">
                <input type="text" name="tm-users" placeholder="Add a User..." id="tm-users" class="tm-input input-medium tm-input-success"/>
            </div>
            <div class="col-md-3">
                <input type="text" name="tm-categories" placeholder="Add a Category..." id="tm-categories" class="tm-input input-medium tm-input-warning"/>
            </div>
            <div class="col-md-3">
                <input type="text" name="tm-date" placeholder="Add a date..." id="tm-date" class="tm-input input-medium tm-input-error"/>
            </div>
        </div>
    </div>
</form>
<div id="savedActivties"></div>

{% endblock %}
